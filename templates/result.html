<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results for {{ domain }} - LLM Search Performance Tracker</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9B4WW61DS4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-9B4WW61DS4');
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
</head>
<body>
    <header>
        <nav>
            <a href="{{ url_for('index') }}" class="home-link"><i class="fas fa-home" aria-hidden="true"></i> Home</a>
        </nav>
    </header>

    <main>
        <h1>Results for {{ domain }}</h1>
        
        <h2>Website Information</h2>
        <p><strong>Title:</strong> {{ info.title }}</p>
        <p><strong>Description:</strong> {{ info.description }}</p>
        
        <h2>Relevant Searches</h2>
        <ol>
        {% for prompt in prompts %}
            <li><a href="#result-{{ loop.index }}">{{ prompt.split('.', 1)[-1].strip().strip('"*') }}</a></li>
        {% endfor %}
        </ol>
        
        <h2>Visibility and Competitors</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Prompt</th>
                        <th>Answer</th>
                        <th>Top Competitors</th>
                        <th>Visible in LLM?</th>
                    </tr>
                </thead>
                <tbody>
                {% for row in table %}
                    <tr id="result-{{ loop.index }}">
                        <td class="expandable">
                            <div class="content">{{ row.prompt.split('.', 1)[-1].strip().strip('"*') }}</div>
                            <button class="expand-btn" aria-label="Expand">+</button>
                        </td>
                        <td class="expandable">
                            <div class="content">{{ row.answer }}</div>
                            <button class="expand-btn" aria-label="Expand">+</button>
                        </td>
                        <td>
                            {% if row.competitors != 'None mentioned' %}
                                <ol>
                                    {% for competitor in row.competitors.split(', ') %}
                                        <li>{{ competitor }}</li>
                                    {% endfor %}
                                </ol>
                            {% else %}
                                {{ row.competitors }}
                            {% endif %}
                        </td>
                        <td class="visibility-status {% if 'Yes' in row.visible %}visible{% else %}not-visible{% endif %}">
                            <span class="visibility-icon">
                                {% if 'Yes' in row.visible %}
                                    {% set rank = row.visible.split('(Rank: ')[1].split(')')[0]|int %}
                                    {% if rank == 1 %}
                                        Congrats, you're first! ü•áüéâ
                                    {% elif rank == 2 %}
                                        Congrats, you're second! ü•àüéâ
                                    {% elif rank == 3 %}
                                        Congrats, you're third! ü•âüéâ
                                    {% else %}
                                        Congrats, you're {{ rank }}th! üéâ
                                    {% endif %}
                                {% else %}
                                    &#10008; No
                                {% endif %}
                            </span>
                            {% if 'No' in row.visible %}
                                <span class="info-icon" onclick="showAdvice('{{ domain }}', '{{ row.prompt|replace("'", "\\'") }}', {{ loop.index }})">‚ÑπÔ∏è</span>
                            {% endif %}
                            <div class="spinner" id="spinner-{{ loop.index }}"></div>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Modal for displaying advice -->
        <div id="adviceModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>How to Improve Visibility</h2>
                <div id="adviceContent"></div>
            </div>
        </div>

        {% if searches_left > 0 %}
            <p class="cta-text">You have {{ searches_left }} free searches left. Want to analyze more domains?</p>
            <div class="cta-container">
                <a href="{{ url_for('index') }}" class="cta-button">Analyze Another Domain</a>
            </div>
        {% else %}
            <p class="cta-text">You've used all your free searches. Want to analyze more domains and get deeper insights?</p>
            <div class="cta-container">
                <a href="https://mv71z3xpmnl.typeform.com/to/bmN8bM2y" target="_blank" class="cta-button waiting-list-button">Join Waiting List for Premium Access</a>
            </div>
        {% endif %}
    </main>

    <footer>
        <p>&copy; 2024 LLM Search Performance Tracker. All rights reserved.</p>
        <nav>
            <a href="#">Privacy Policy</a>
            <a href="#">Terms of Service</a>
            <a href="#">Contact Us</a>
        </nav>
    </footer>

    <a href="#" id="back-to-top" class="back-to-top" aria-label="Back to top">
        <i class="fas fa-chevron-up" aria-hidden="true"></i>
    </a>

    <script>
        document.querySelectorAll('.expand-btn').forEach(button => {
            button.addEventListener('click', function() {
                const content = this.previousElementSibling;
                content.classList.toggle('expanded');
                this.textContent = content.classList.contains('expanded') ? '-' : '+';
            });
        });

        // Modal functionality
        var modal = document.getElementById("adviceModal");
        var span = document.getElementsByClassName("close")[0];

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function showAdvice(domain, prompt, rowIndex) {
            const spinner = document.getElementById(`spinner-${rowIndex}`);
            spinner.style.display = 'inline-block';
            
            fetch('/get_advice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({domain: domain, prompt: prompt}),
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                const formattedAdvice = data.advice.replace(/(\d+\.)/g, '\n$1');
                document.getElementById("adviceContent").innerText = formattedAdvice;
                modal.style.display = "block";
            })
            .catch((error) => {
                spinner.style.display = 'none';
                console.error('Error:', error);
            });
        }

        // Back to top button functionality
        var backToTopButton = document.getElementById("back-to-top");
        window.onscroll = function() {scrollFunction()};

        function scrollFunction() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                backToTopButton.style.display = "block";
            } else {
                backToTopButton.style.display = "none";
            }
        }

        backToTopButton.onclick = function() {
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        }
    </script>
</body>
</html>