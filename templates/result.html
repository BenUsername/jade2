<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results for {{ domain }} - LLM Search Performance Tracker</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9B4WW61DS4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-9B4WW61DS4');
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîç</text></svg>">
</head>
<body>
    <h1>Results for {{ domain }}</h1>
    
    <h2>Website Information</h2>
    <p><strong>Title:</strong> {{ info.title }}</p>
    <p><strong>Description:</strong> {{ info.description }}</p>
    
    <h2>Relevant Searches</h2>
    <ol>
    {% for prompt in prompts %}
        <li><a href="#result-{{ loop.index }}">{{ prompt.split('.', 1)[-1].strip().strip('"*') }}</a></li>
    {% endfor %}
    </ol>
    
    <h2>Visibility and Competitors</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Prompt</th>
                    <th>Answer</th>
                    <th>Top Competitors</th>
                    <th>Visible in LLM?</th>
                </tr>
            </thead>
            <tbody>
            {% for row in table %}
                <tr id="result-{{ loop.index }}">
                    <td class="expandable">
                        <div class="content">{{ row.prompt.split('.', 1)[-1].strip().strip('"*') }}</div>
                        <button class="expand-btn" aria-label="Expand">+</button>
                    </td>
                    <td class="expandable">
                        <div class="content">{{ row.answer }}</div>
                        <button class="expand-btn" aria-label="Expand">+</button>
                    </td>
                    <td>
                        {% if row.competitors != 'None mentioned' %}
                            <ol>
                                {% for competitor in row.competitors.split(', ') %}
                                    <li>{{ competitor }}</li>
                                {% endfor %}
                            </ol>
                        {% else %}
                            {{ row.competitors }}
                        {% endif %}
                    </td>
                    <td class="visibility-status {% if 'Yes' in row.visible %}visible{% else %}not-visible{% endif %}">
                        <span class="visibility-icon">
                            {% if 'Yes' in row.visible %}
                                &#10004; Yes
                            {% else %}
                                &#10008; No
                            {% endif %}
                        </span>
                        {% if 'No' in row.visible %}
                            <span class="info-icon" onclick="showAdvice('{{ domain }}', '{{ row.prompt }}', {{ loop.index }})">‚ÑπÔ∏è</span>
                        {% endif %}
                        <div class="spinner" id="spinner-{{ loop.index }}"></div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modal for displaying advice -->
    <div id="adviceModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>How to Improve Visibility</h2>
            <div id="adviceContent"></div>
        </div>
    </div>

    {% if searches_left > 0 %}
        <p class="cta-text">You have {{ searches_left }} free searches left. Want to analyze more domains?</p>
        <div class="cta-container">
            <a href="{{ url_for('index') }}" class="cta-button">Analyze Another Domain</a>
        </div>
    {% else %}
        <p class="cta-text">You've used all your free searches. Want to analyze more domains and get deeper insights?</p>
        <div class="cta-container">
            <a href="https://mv71z3xpmnl.typeform.com/to/bmN8bM2y" target="_blank" class="cta-button waiting-list-button">Join Waiting List for Premium Access</a>
        </div>
    {% endif %}

    <script>
        document.querySelectorAll('.expand-btn').forEach(button => {
            button.addEventListener('click', function() {
                const content = this.previousElementSibling;
                content.classList.toggle('expanded');
                this.textContent = content.classList.contains('expanded') ? '-' : '+';
            });
        });

        // Modal functionality
        var modal = document.getElementById("adviceModal");
        var span = document.getElementsByClassName("close")[0];

        span.onclick = function() {
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        function showAdvice(domain, prompt, rowIndex) {
            const spinner = document.getElementById(`spinner-${rowIndex}`);
            spinner.style.display = 'inline-block';
            
            fetch('/get_advice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({domain: domain, prompt: prompt}),
            })
            .then(response => response.json())
            .then(data => {
                spinner.style.display = 'none';
                const formattedAdvice = data.advice.replace(/(\d+\.)/g, '\n$1');
                document.getElementById("adviceContent").innerText = formattedAdvice;
                modal.style.display = "block";
            })
            .catch((error) => {
                spinner.style.display = 'none';
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>
